# Sysmem v2.0 - é¡¹ç›®æ¶æ„é“¾æ¡åŒ–ç®¡ç†ç³»ç»Ÿ
# æ”¯æŒæ™ºèƒ½äº¤äº’å¼æ›´æ–°å’ŒGité›†æˆå˜æ›´æ£€æµ‹

.PHONY: help quick-install install install-dev uninstall build clean test lint format check-deps sync-version global-install demo interactive-demo

# é»˜è®¤ç›®æ ‡
help:
	@echo "Sysmem v2.0 - é¡¹ç›®æ¶æ„é“¾æ¡åŒ–ç®¡ç†ç³»ç»Ÿ"
	@echo "æ”¯æŒæ™ºèƒ½äº¤äº’å¼æ›´æ–°å’ŒGité›†æˆå˜æ›´æ£€æµ‹"
	@echo ""
	@echo "ğŸš€ å®‰è£…å‘½ä»¤:"
	@echo "  make quick-install    - ğŸŒŸ ä¸€é”®æ™ºèƒ½å®‰è£…ï¼ˆå¼ºçƒˆæ¨èï¼‰"
	@echo "  make install         - å®‰è£…åˆ°ç”¨æˆ·ç¯å¢ƒ"
	@echo "  make install-dev     - å¼€å‘æ¨¡å¼å®‰è£…"
	@echo "  make global-install   - å…¨å±€å®‰è£…ï¼ˆéœ€è¦sudoï¼‰"
	@echo "  make uninstall       - å¸è½½åŒ…"
	@echo ""
	@echo "ğŸ¤– æ™ºèƒ½åŠŸèƒ½æ¼”ç¤º:"
	@echo "  make demo            - è¿è¡Œæ™ºèƒ½å®‰è£…æ£€æŸ¥"
	@echo "  make interactive-demo - æ¼”ç¤ºæ™ºèƒ½äº¤äº’å¼æ›´æ–°"
	@echo ""
	@echo "ğŸ”§ å¼€å‘å·¥å…·:"
	@echo "  make build           - æ„å»ºåˆ†å‘åŒ…"
	@echo "  make clean           - æ¸…ç†æ„å»ºæ–‡ä»¶"
	@echo "  make test            - è¿è¡Œæµ‹è¯•"
	@echo "  make lint            - ä»£ç æ£€æŸ¥"
	@echo "  make format          - ä»£ç æ ¼å¼åŒ–"
	@echo "  make check-deps      - æ£€æŸ¥ä¾èµ–"
	@echo "  make sync-version    - åŒæ­¥ç‰ˆæœ¬å·"

# æ£€æŸ¥Pythonç‰ˆæœ¬
check-python:
	@python3 -c "import sys; assert sys.version_info >= (3, 8), 'éœ€è¦Python 3.8æˆ–æ›´é«˜ç‰ˆæœ¬'"

# æ£€æŸ¥ä¾èµ–
check-deps: check-python
	@echo "æ£€æŸ¥æ„å»ºä¾èµ–..."
	@python3 -m pip install --upgrade pip setuptools wheel build
	@echo "ä¾èµ–æ£€æŸ¥å®Œæˆ"

# ğŸŒŸ ä¸€é”®æ™ºèƒ½å®‰è£…
quick-install:
	@echo "ğŸŒŸ Sysmem v2.0 ä¸€é”®æ™ºèƒ½å®‰è£…"
	@echo "================================"
	@if [[ -f "quick_install.sh" ]]; then \
		./quick_install.sh; \
	else \
		echo "âŒ ä¸€é”®å®‰è£…è„šæœ¬ä¸å­˜åœ¨"; \
		exit 1; \
	fi

# ç”¨æˆ·æ¨¡å¼å®‰è£…
install: check-deps
	@echo "å®‰è£…Sysmemåˆ°ç”¨æˆ·ç¯å¢ƒ..."
	python3 -m pip install -e .
	@echo "å®‰è£…å®Œæˆï¼ä½¿ç”¨ 'python3 scripts/collect_data.py --help' å¼€å§‹ä½¿ç”¨"

# å¼€å‘æ¨¡å¼å®‰è£…
install-dev: check-deps
	@echo "å¼€å‘æ¨¡å¼å®‰è£…Sysmem..."
	python3 -m pip install -e ".[dev]"
	@echo "å¼€å‘å®‰è£…å®Œæˆï¼"

# å…¨å±€å®‰è£…
global-install: check-deps
	@echo "å…¨å±€å®‰è£…Sysmemï¼ˆéœ€è¦sudoæƒé™ï¼‰..."
	sudo python3 -m pip install .
	@echo "å…¨å±€å®‰è£…å®Œæˆï¼"

# å¸è½½
uninstall:
	@echo "å¸è½½Sysmem..."
	python3 -m pip uninstall -y sysmem || true
	@echo "å¸è½½å®Œæˆ"

# æ„å»ºåˆ†å‘åŒ…
build: check-deps clean
	@echo "æ„å»ºSysmemåˆ†å‘åŒ…..."
	python3 -m build
	@echo "æ„å»ºå®Œæˆï¼"
	@ls -la dist/

# æ¸…ç†æ„å»ºæ–‡ä»¶
clean:
	@echo "æ¸…ç†æ„å»ºæ–‡ä»¶..."
	rm -rf build/
	rm -rf dist/
	rm -rf *.egg-info/
	rm -rf __pycache__/
	rm -rf .pytest_cache/
	rm -rf .mypy_cache/
	find . -name "*.pyc" -delete
	find . -name "*.pyo" -delete
	@echo "æ¸…ç†å®Œæˆ"

# è¿è¡Œæµ‹è¯•
test:
	@echo "è¿è¡Œæµ‹è¯•..."
	python3 -m pytest tests/ -v || echo "æµ‹è¯•æœªæ‰¾åˆ°æˆ–å¤±è´¥"

# ä»£ç æ£€æŸ¥
lint:
	@echo "è¿è¡Œä»£ç æ£€æŸ¥..."
	python3 -m flake8 scripts/ sysmem/ || echo "flake8æœªå®‰è£…æˆ–æ£€æŸ¥å®Œæˆ"
	python3 -m mypy sysmem/ || echo "mypyæœªå®‰è£…æˆ–æ£€æŸ¥å®Œæˆ"

# ä»£ç æ ¼å¼åŒ–
format:
	@echo "æ ¼å¼åŒ–ä»£ç ..."
	python3 -m black scripts/ sysmem/ || echo "blackæœªå®‰è£…"
	python3 -m isort scripts/ sysmem/ || echo "isortæœªå®‰è£…"

# åŒæ­¥ç‰ˆæœ¬å·
sync-version:
	@echo "ç‰ˆæœ¬åŒæ­¥..."
	@echo "ç‰ˆæœ¬åŒæ­¥å®Œæˆ"

# å®Œæ•´çš„å‘å¸ƒæµç¨‹
release: clean test lint build
	@echo "å‘å¸ƒå‡†å¤‡å®Œæˆï¼"
	@echo "åˆ†å‘åŒ…ä½äº dist/ ç›®å½•"

# ğŸ¤– æ™ºèƒ½åŠŸèƒ½æ¼”ç¤º
demo:
	@echo "ğŸŒŸ Sysmem v2.0 æ™ºèƒ½å®‰è£…æ£€æŸ¥æ¼”ç¤º"
	@echo "================================"
	@python3 scripts/install_project.py

# æ™ºèƒ½äº¤äº’å¼æ›´æ–°æ¼”ç¤º
interactive-demo:
	@echo "ğŸ¤– æ™ºèƒ½äº¤äº’å¼æ›´æ–°æ¼”ç¤º"
	@echo "================================"
	@echo "è¿™ä¸ªå‘½ä»¤å°†æ¼”ç¤ºæ™ºèƒ½äº¤äº’å¼æ›´æ–°åŠŸèƒ½ï¼š"
	@echo "1. è‡ªåŠ¨æ£€æµ‹æ–‡ä»¶å˜æ›´"
	@echo "2. åˆ†æå½±å“èŒƒå›´"
	@echo "3. æä¾›æ›´æ–°å»ºè®®"
	@echo "4. ç”¨æˆ·äº¤äº’ç¡®è®¤"
	@echo ""
	@echo "è¿è¡Œä»¥ä¸‹å‘½ä»¤å¼€å§‹æ¼”ç¤ºï¼š"
	@echo "python3 scripts/collect_data.py --interactive"
	@echo ""
	@echo "æˆ–è€…æŸ¥çœ‹å¸®åŠ©ï¼š"
	@echo "python3 scripts/collect_data.py --help"